# FleetTracker

FleetTracker — система управления автопарком с ролевой моделью (администратор, менеджер, водитель), JWT-аутентификацией и ведением учёта транспорта, поездок и обслуживания. Проект упакован в Docker и готов к запуску на Linux сервере.

## Возможности
- Хранение транспорта и водителей, привязка водителя к машине.
- Учёт маршрутов и их протяжённости, запрос оптимального маршрута по координатам.
- Учёт обслуживания транспорта и его стоимости.
- Разграничение прав: администратор управляет пользователями, менеджер ведёт автопарк, водитель видит свои объекты.

## Требования
- Docker и Docker Compose.
- Открытые порты 5000 (API) и 55432 (PostgreSQL на хосте, проброшен в контейнер на 5432) или измените их в `docker-compose.yml`.

## Запуск на Linux (покомандно)
1. **Клонировать репозиторий**
   ```bash
   git clone <repo_url> && cd FleetTracker
   ```

2. **Подготовить переменные окружения**
   ```bash
   cp .env.example .env
   # при необходимости скорректируйте DATABASE_URL / JWT_SECRET_KEY / пароли БД
   ```

3. **Построить и поднять контейнеры** (создастся БД `fleettracker` в контейнере):
   ```bash
   docker compose build
   docker compose up -d
   ```

4. **Выполнить миграции** (если контейнер уже поднят, команда изнутри web-контейнера):
   ```bash
   docker compose exec web flask db upgrade
   ```

5. **Создать администратора** (запросит логин/пароль интерактивно):
   ```bash
   docker compose exec web flask create-admin
   ```

6. **Проверить, что сервис работает**
   - Откройте http://localhost:5000/ — отобразится лёгкий веб-интерфейс, который работает напрямую с API.
   - Или выполните ручной запрос:
     ```bash
     curl -X POST http://localhost:5000/auth/login \
       -H "Content-Type: application/json" \
       -d '{"username":"<admin>","password":"<password>"}'
     ```
     В ответе должен прийти `access_token`.

7. **Остановить сервис при необходимости**
   ```bash
   docker compose down
   ```

## Основные переменные окружения
`docker-compose.yml` задаёт значения по умолчанию, но их можно переопределить:
- `DATABASE_URL` — строка подключения к БД (пример: `postgresql://postgres:postgres@db:5432/fleettracker`; для подключения с хоста используйте порт `55432`).
- `JWT_SECRET_KEY` — секрет для подписи JWT (замените в продакшене).
- `FLASK_APP` — модуль приложения (`app.py`).

## Ключевые эндпоинты
> Все запросы, кроме `/auth/login`, требуют заголовок `Authorization: Bearer <token>`.

Фронтенд, доступный на `/`, отправляет запросы к тем же эндпоинтам и может быть использован для быстрой проверки API.

- `POST /auth/login` — вход, возвращает `access_token` и роль.
- `GET /auth/me` — данные текущего пользователя.
- `POST /auth/users` — **админ**: создать пользователя (можно сразу создать водителя через поле `driver`).
- `GET /auth/users` — **админ**: список пользователей.
- `PATCH/DELETE /auth/users/<id>` — **админ**: обновить/удалить пользователя.
- `GET/POST/PATCH/DELETE /drivers` — управление водителями (админ/менеджер, удалять может только админ).
- `GET/POST/PATCH/DELETE /vehicles` — управление транспортом (админ/менеджер, водители видят только свои машины).
- `POST /vehicles/<id>/assign-driver` — назначить водителя на машину (админ/менеджер).
- `GET/POST/DELETE /routes` — учёт поездок (водитель видит/создаёт только свои).
- `POST /routes/optimal` — расчёт оптимального обхода точек по координатам (возвращает порядок и длину в км).
- `GET/POST /maintenance` — учёт обслуживания (создание: админ/менеджер; просмотр: все, водители только по своим авто).
- `GET /admin/stats` — сводка по объектам (только админ).

## Обновление зависимостей без Docker (локально)
```bash
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
export FLASK_APP=app.py
flask db upgrade
flask run --host 0.0.0.0 --port 5000
```

## Примечания
- Пароли хранятся в захэшированном виде (`werkzeug.security`).
- Роли проверяются через клеймы в JWT.
- Оптимизатор маршрута использует "brute force" по заданным точкам, поэтому подходит для небольших списков остановок.
