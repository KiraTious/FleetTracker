<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>FleetTracker – Кабинет администратора</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div>
        <div class="sidebar-logo">
          <div class="sidebar-logo-badge">FT</div>
          <div class="sidebar-logo-title">
            <span>FleetTracker</span>
            <span>Администрирование</span>
          </div>
        </div>

        <div class="sidebar-nav">
          <div class="sidebar-nav-section-title">Админ</div>
          <a class="sidebar-link sidebar-link--active">
            <span>Пользователи</span>
            <span>●</span>
          </a>
          <a class="sidebar-link">
            <span>Транспорт</span>
          </a>
          <a class="sidebar-link">
            <span>Обслуживание</span>
          </a>
        </div>
      </div>

      <div class="sidebar-footer">
        <div class="sidebar-user">
          <div class="sidebar-avatar">АД</div>
          <div>
            <div style="font-size:0.85rem;">Администратор</div>
            <div style="font-size:0.75rem;opacity:0.75;">Admin</div>
          </div>
        </div>
        <a href="index.html" class="btn btn--ghost btn--pill" style="padding:0.3rem 0.7rem;font-size:0.75rem;">
          Выйти из системы
        </a>
      </div>
    </aside>

    <main class="main">
      <header class="main-header">
        <div class="main-header-left">
          <div class="chip">Роль: администратор</div>
          <h1 class="main-title">Управление пользователями и автопарком</h1>
          <p class="main-subtitle">
            Создание учетных записей, добавление водителей и транспортных средств, управление обслуживанием.
          </p>
        </div>
        <div class="main-header-right">
          <span class="tag-role">Администратор</span>
          <button class="btn btn--ghost btn--pill">Экспорт</button>
        </div>
      </header>

      <nav class="subnav">
        <a href="#users" class="subnav-link">Пользователи и роли</a>
        <a href="#vehicles" class="subnav-link">Транспортные средства</a>
        <a href="#maintenance" class="subnav-link">Обслуживание</a>
      </nav>

      <section class="main-grid main-grid--full">
        <div class="main-grid-column">
          <!-- Блок: Пользователи -->
          <article class="card" id="users">
            <div class="card-header">
              <div>
                <div class="card-title">Создать пользователя</div>
                <div class="card-subtitle">
                  Создает запись в Users, при необходимости сразу же в Drivers и привязку к Vehicles.
                </div>
              </div>
            </div>

            <form id="user-create-form">
              <div class="section-title">Учетная запись (Users)</div>
              <div class="form-grid">
                <div class="form-field">
                  <label class="form-label">Логин</label>
                  <input id="user-username" type="text" placeholder="user.login">
                </div>
                <div class="form-field">
                  <label class="form-label">Роль</label>
                  <select id="user-role">
                    <option value="driver">Водитель</option>
                    <option value="manager">Менеджер</option>
                    <option value="admin">Администратор</option>
                  </select>
                </div>
                <div class="form-field">
                  <label class="form-label">Пароль</label>
                  <input id="user-password" type="password" placeholder="••••••••">
                </div>
                <div class="form-field">
                  <label class="form-label">Подтверждение пароля</label>
                  <input id="user-password-confirm" type="password" placeholder="••••••••">
                </div>
              </div>

              <div class="section-title">Данные водителя (Drivers)</div>
              <p class="text-muted" style="margin-bottom:0.4rem;">
                Заполняется только для роли «Водитель» (в макете поля всегда видны).
              </p>
              <div class="form-grid">
                <div class="form-field">
                  <label class="form-label">Имя</label>
                  <input id="driver-first-name" type="text" placeholder="Иван">
                </div>
                <div class="form-field">
                  <label class="form-label">Фамилия</label>
                  <input id="driver-last-name" type="text" placeholder="Петров">
                </div>
                <div class="form-field">
                  <label class="form-label">Номер удостоверения</label>
                  <input id="driver-license" type="text" placeholder="77 11 234567">
                </div>
              </div>

              <div class="section-title">Закрепление за ТС (Vehicle)</div>
              <div class="form-grid">
                <div class="form-field">
                  <label class="form-label">Госномер ТС (опционально)</label>
                  <input id="user-vehicle-reg" type="text" placeholder="А123ВС 77">
                </div>
                <div class="form-field">
                  <label class="form-label">Комментарий</label>
                  <textarea placeholder="Например: ночные смены, только Москва"></textarea>
                </div>
              </div>

              <div style="display:flex;justify-content:flex-end;gap:0.4rem;margin-top:0.2rem;">
                <button type="button" class="btn btn--ghost btn--pill">
                  Очистить
                </button>
                <button type="submit" class="btn btn--primary btn--pill">Создать пользователя</button>
              </div>
              <p id="user-create-status" class="text-muted" style="height:1.2rem;margin-top:0.4rem;"></p>
            </form>
          </article>

          <article class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Список пользователей</div>
                <div class="card-subtitle">Удаление и базовая информация</div>
              </div>
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th>Логин</th>
                  <th>Роль</th>
                  <th>ФИО / водитель</th>
                  <th>ТС</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>driver.ivan</td>
                  <td>Водитель</td>
                  <td>Иван Петров</td>
                  <td>А123ВС 77</td>
                  <td>
                    <button class="btn btn--danger btn--pill" style="font-size:0.7rem;padding:0.25rem 0.7rem;">
                      Удалить
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>manager.olga</td>
                  <td>Менеджер</td>
                  <td>Ольга Менеджер</td>
                  <td>—</td>
                  <td>
                    <button class="btn btn--danger btn--pill" style="font-size:0.7rem;padding:0.25rem 0.7rem;">
                      Удалить
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>admin</td>
                  <td>Администратор</td>
                  <td>Администратор системы</td>
                  <td>—</td>
                  <td>
                    <button class="btn btn--danger btn--pill" style="font-size:0.7rem;padding:0.25rem 0.7rem;">
                      Удалить
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </article>

          <!-- Блок: Транспорт -->
          <article class="card" id="vehicles">
            <div class="card-header">
              <div>
                <div class="card-title">Транспортные средства</div>
                <div class="card-subtitle">
                  Добавление новых машин и их базовых параметров (таблица Vehicles).
                </div>
              </div>
            </div>

            <div class="section-title">Добавить транспортное средство</div>
            <form id="vehicle-create-form">
              <div class="form-grid">
                <div class="form-field">
                  <label class="form-label">Марка</label>
                  <input id="vehicle-brand" type="text" placeholder="Mercedes-Benz">
                </div>
                <div class="form-field">
                  <label class="form-label">Модель</label>
                  <input id="vehicle-model" type="text" placeholder="Sprinter 315 CDI">
                </div>
                <div class="form-field">
                  <label class="form-label">Регистрационный номер</label>
                  <input id="vehicle-reg-number" type="text" placeholder="А123ВС 77">
                </div>
                <div class="form-field">
                  <label class="form-label">Год выпуска</label>
                  <input type="number" placeholder="2020">
                </div>
              </div>

              <div style="display:flex;justify-content:flex-end;gap:0.4rem;">
                <button type="button" class="btn btn--ghost btn--pill">
                  Очистить
                </button>
                <button type="submit" class="btn btn--primary btn--pill">Добавить ТС</button>
              </div>
              <p id="vehicle-create-status" class="text-muted" style="height:1.2rem;margin-top:0.4rem;"></p>
            </form>

            <div class="section-title" style="margin-top:0.8rem;">Список ТС</div>
            <table class="table">
              <thead>
                <tr>
                  <th>ТС</th>
                  <th>Гос. номер</th>
                  <th>Статус</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Mercedes Sprinter</td>
                  <td>А123ВС 77</td>
                  <td><span class="status status--done">В работе</span></td>
                  <td>
                    <button class="btn btn--ghost btn--pill" style="font-size:0.7rem;padding:0.25rem 0.6rem;">
                      Редактировать
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>Ford Transit</td>
                  <td>В456КН 77</td>
                  <td><span class="status status--planned">На ТО</span></td>
                  <td>
                    <button class="btn btn--ghost btn--pill" style="font-size:0.7rem;padding:0.25rem 0.6rem;">
                      Редактировать
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </article>

          <!-- Блок: Обслуживание -->
          <article class="card" id="maintenance">
            <div class="card-header">
              <div>
                <div class="card-title">Обслуживание ТС</div>
                <div class="card-subtitle">
                  Фиксация работ и стоимости (таблица Maintenance).
                </div>
              </div>
            </div>

            <div class="section-title">Добавить запись обслуживания</div>
            <form>
              <div class="form-grid">
                <div class="form-field">
                  <label class="form-label">Транспортное средство</label>
                  <select>
                    <option>А123ВС 77 · Mercedes Sprinter</option>
                    <option>В456КН 77 · Ford Transit</option>
                  </select>
                </div>
                <div class="form-field">
                  <label class="form-label">Тип работ</label>
                  <input type="text" placeholder="Например, плановое ТО">
                </div>
                <div class="form-field">
                  <label class="form-label">Дата</label>
                  <input type="date">
                </div>
                <div class="form-field">
                  <label class="form-label">Стоимость, ₽</label>
                  <input type="number" placeholder="0">
                </div>
              </div>

              <div style="display:flex;justify-content:flex-end;gap:0.4rem;">
                <button type="button" class="btn btn--ghost btn--pill">
                  Очистить
                </button>
                <button type="button" class="btn btn--primary btn--pill">
                  Сохранить запись
                </button>
              </div>
            </form>

            <div class="section-title" style="margin-top:0.8rem;">Последние работы</div>
            <table class="table">
              <thead>
                <tr>
                  <th>ТС</th>
                  <th>Дата</th>
                  <th>Тип работ</th>
                  <th>Стоимость</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>А123ВС 77</td>
                  <td>02.12.2025</td>
                  <td>Плановое ТО</td>
                  <td>9 800 ₽</td>
                </tr>
                <tr>
                  <td>В456КН 77</td>
                  <td>28.11.2025</td>
                  <td>Замена передних тормозов</td>
                  <td>12 300 ₽</td>
                </tr>
              </tbody>
            </table>
          </article>
        </div>
      </section>
    </main>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('access_token');
      if (!token) {
        window.location.href = '/';
        return;
      }

      const userForm = document.getElementById('user-create-form');
      const userStatus = document.getElementById('user-create-status');
      const vehicleForm = document.getElementById('vehicle-create-form');
      const vehicleStatus = document.getElementById('vehicle-create-status');

      const setStatus = (node, message, isError = false) => {
        if (!node) return;
        node.textContent = message;
        node.className = isError ? 'text-error' : 'text-muted';
      };

      const postJSON = async (url, body) => {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(body),
        });
        const data = await response.json();
        return { response, data };
      };

      userForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        setStatus(userStatus, 'Создаем пользователя...');

        const password = document.getElementById('user-password')?.value || '';
        const passwordConfirm = document.getElementById('user-password-confirm')?.value || '';
        if (password !== passwordConfirm) {
          setStatus(userStatus, 'Пароли не совпадают', true);
          return;
        }

        const payload = {
          username: document.getElementById('user-username')?.value.trim(),
          password,
          role: document.getElementById('user-role')?.value,
          first_name: document.getElementById('driver-first-name')?.value.trim(),
          last_name: document.getElementById('driver-last-name')?.value.trim(),
          license_number: document.getElementById('driver-license')?.value.trim(),
          vehicle_reg_number: document.getElementById('user-vehicle-reg')?.value.trim(),
        };

        try {
          const { response, data } = await postJSON('/admin/users', payload);
          if (!response.ok) {
            setStatus(userStatus, data.message || 'Не удалось создать пользователя', true);
            return;
          }
          setStatus(userStatus, `Создан пользователь ${data.username}`);
          userForm.reset();
        } catch (err) {
          setStatus(userStatus, 'Ошибка сети или сервера', true);
        }
      });

      vehicleForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        setStatus(vehicleStatus, 'Добавляем ТС...');

        const payload = {
          brand: document.getElementById('vehicle-brand')?.value.trim(),
          model: document.getElementById('vehicle-model')?.value.trim(),
          reg_number: document.getElementById('vehicle-reg-number')?.value.trim(),
        };

        try {
          const { response, data } = await postJSON('/admin/vehicles', payload);
          if (!response.ok) {
            setStatus(vehicleStatus, data.message || 'Не удалось добавить ТС', true);
            return;
          }
          setStatus(vehicleStatus, `ТС ${data.reg_number} добавлено`);
          vehicleForm.reset();
        } catch (err) {
          setStatus(vehicleStatus, 'Ошибка сети или сервера', true);
        }
      });
    });
  </script>
</body>
</html>
